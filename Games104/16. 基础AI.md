- Navigation
- Steering
- Crowd Simulation 
- Sensing 
- Classic Decision Making Algorithms

### Navigation
- Navigation Steps
	- Map representation
		- Walkable Area
			- We need to tell AI agents where they can walk – Walkable area
			- 同一个地图对于不同的agent可行走区域可能是不一样的，比如士兵和坦克，飞机
			- Walkable area of players is determined by character motion capabilities
				- Physical Collision
				- Climbing slope/height
				- Jumping distance
			- Simulating movement of AI agents as players costs too much
			- AI agents are still expected to have the same walkable area as players
			- 可行走区域表达形式
				- Waypoint Network
					- Network connecting critical points (waypoints) from the map
					- Waypoint sources: 
						- Designed important locations 
						- Corner points to cover walkable area 
						- Internal points to connect near-by waypoints adding flexibility to navigation
					- Usage of waypoint network is similar to subway system
						- Find the nearest points to get on and off the network
						- Plan the path on the waypoint network
					- Pros:
						- Easy to implement
						- Fast path finding, even for large maps 
					- Cons: 
						- Limited flexibility: must go to the nearest point in the network before navigation 
						- Waypoint selection requires manual intervention
				- Grid 
					- Intuitive discretization of map
					- Uniform subdivision into small regular grid shapes
					- Common grid shapes 
						- Square
						- Triangle 
						- Hexagon
					- Grid property could be modified in runtime to reflect dynamic environmental changes
					- Pros: •
						- Easy to implement 
						- Uniform data structure 
						- Dynamic 
					- Cons: 
						- Accuracy depends on grid resolution
						- Dense grid lowers pathfinding performance，格子很密集的话，效率会低，因为线性的存储方式导致cache miss
						- High memory consumption 
						- Hard to handle 3D map，很难表达层次结构，比如桥
				- Navigation Mesh
					- Solves the problem of representing overlapped walkable areas 
					- Approximates the walkable area of character controller based on physical collision and motion capabilities
					- Lowers network density to boost pathfinding performance
					- Convex Polygon of NavMesh
						- Pathfinding generates a series of polygon (Polygon Corridor) need to walk through
						- Convexity guarantees the final path is limited in the polygon and two adjacent polygons have only one common edge (Portal)（两个凸多边形之间只会有一个公共边）
						- 寻路的时候要穿过一个凸多边形，只会穿过一次，如果是凹多边形，可能会有多次
					- Pros: 
						- Support 3D walkable surface 
						- Accurate （精确）
						- Fast in pathfinding 
						- Flexible for selection of start/destination 
						- Dynamic 
					- Cons: 
						- Complex generation algorithm 
						- Not support 3D space（不能给直升飞机这种agent寻路）
				- Sparse Voxel Octree（八叉树）
					- Represents “flyable” 3D space
					- Similar to spatial partitioning
					- Finest level voxels represents complicated boundary
					- Coarser-level voxels represents uniform regions
					- 存储比较费？
					- 寻路比较麻烦？
	- Path finding
		- Distances in map representations can be abstracted as edge costs in graph![[Pasted image 20230122131030.png]]
		- Pathfinding can be abstracted as shortest path problem in non-directional graph
		- Depth-First Search
			- Expand most recently added
		- Breadth-First Search
			- Expand least recently added
		- Dijkstra Algorithm
		- A Star (A*)
			- implement![[Pasted image 20230122143215.png]]
			- Expand lowest cost in list 
			- Distance is known distance from source + heuristic 
			- Greedy: stops when reaches the goal
			- Cost calculation
				- Cost calculation: 𝑓 𝑛 = 𝑔(𝑛) + ℎ(𝑛) 
				- 𝑔(𝑛): the exact cost of the path from the start to node 𝑛 
				- ℎ(𝑛): the estimated cost from node 𝑛 to the goal
			- Heuristic On Grids
				- For 4 directions of movement, we can use Manhattan distance
				- 𝐷1: cost for moving to the adjacent node
				- ℎ(𝑛) = 𝐷1 ∙ (𝑑𝑥 + 𝑑𝑦)
					- 𝑑𝑥 = |𝑥𝑛 − 𝑥𝑔𝑜𝑎𝑙| , 𝑑𝑦 = |𝑦𝑛 − 𝑦𝑔𝑜𝑎𝑙|
			- Heuristic On NavMesh
				- Multiple choices when evaluating cost on NavMesh 
					- Using polygon centers or vertices usually over-estimate（过高估计） the cost 
					- Using hybrid（混合） method introduces（引入） too many points to check
					- Midpoints of edges – a good balance
				- On a navigation mesh that allows any angle of movement, use a straight line distance 
				- Use midpoint of the edge entering the current node as node cost calculation point 
				- 𝐷: the cost for moving unit distance in any direction
					- ℎ(𝑛) = 𝐷 ∙ 欧拉距离
			- Heuristic
				- ℎ(𝑛) controls A* behavior:
					- With 100% accurate estimates, get shortest paths quickly
					- Too low, continue to get shortest paths, but slow down
					- Too high, exit early without shortest path
				- Balance between pathfinding speed and accuracy
	- Path smoothing
		- Why we need path smoothing •
			- Zigzag, many unnecessary turns （路径很曲折）
		- “String Pulling” – Funnel Algorithm（烟囱算法）
			- The scope of the funnel is the possible scope of the path 
			- Narrow the funnel if necessary to fit the portal
			- Terminate when the goal is in the funnel
			- 图1![[Pasted image 20230122143904.png]]
			- 图2![[Pasted image 20230122143915.png]]
	- NavMesh Generation 
		- Voxelization
			- Sample collision scene by voxelization
		- Region Segmentation
			- Calculate the distance of each voxel to border 
			- Mark border voxels by AgentRadius to avoid clipping
			- Watershed Algorithm
				- Gradually “flood” the “terrain” 
				- Form “watershed” (dividing ridge) when “pools” meet
			- Segment the “neighboring” voxels into regions to provide a good basis for polygon mesh
			- Regions don’t have overlapping voxels in 2D
		- Mesh Generation
			- Generate NavMesh from segmented regions
	- NavMesh Advanced Features
		- Polygon Flag
			- Useful for marking terrain types: plains, mountain, water, etc. 
				- “Paint colors” to add user-defined regions 
				- Polygons generated from user-defined regions have special flag
		- Tile
			- 把世界分块，障碍物移动的话，只更新障碍物所在的块的navmesh
			- Fast for responding to dynamic objects 
			- Avoid rebuilding the entire NavMesh 
			- TileSize – trade-off between pathfinding and dynamic rebuilding performance
		- Off-mesh Link
			- Allow agents to jump or teleport


### Steering
- From Path to Motion
	- Cars cannot follow planned path exactly 
	- Motion of cars are limited by theirs motion abilities: 
		- Linear acceleration (throttle/brake) 
		- Angular acceleration (steering force) 
	- Motion needs to be adjusted according to the limits
- Steering Behaviors
	- 行为分类[[Stear Behaviors.canvas]]
	- Seek / Flee
		- Steer the agent towards / away from the target
		- Position matching in the nature 
		- Accelerate with max acceleration towards / away from the target
		- Will oscillate around the target
		- Input: 
			- Self position 
			- Target position 
		- Output: 
			- Acceleration
	- Seek / Flee Variations
		- Modifying the target in runtime can generate new steering behaviors
		- Pursue
		- Path Following
		- Wander
		- Flow Field Following
	- Velocity Match
		- Matches the target velocity
		- Calculate acceleration from matching time and velocity differences 
		- Clamp the acceleration by maximum acceleration of agents
		- Input: 
			- Target velocity 
			- Self velocity 
			- Matching time 
		- Output:
			- Acceleration
	- Align
		- Matches target orientation
		- 也需要有match的过程，先加速再减速平稳match
		- Input: 
			- Target orientation 
			- Self orientation 
		- Output: 
			- Angular acceleration

### Crowd Simulation
- A large group of individuals share information in the same environment alone or in a group
	- Collision avoidance 
	- Swarming 
	- Motion in formation
- Crowd Simulation Models
	- Started from “Boids” system of Reynolds 
	- Three families of models:
		- Microscopic models （微观）
			- “Bottom-Up” 
			- Focus on individuals 
		- Macroscopic models （宏观）
			- Crowd as a unified and continuous entity 
		- Mesoscopic models （混合）
			- Divide the crowd into groups
	- Microscopic Models
		- Rule-based Models
			- Flock dynamics of animal crowds as an emergent behavior by modeling motion of each individuals with simple predefined rules:
				- Separation: to steer away from all of its neighbors 
				- Cohesion: to steer towards the “center of mass” 
				- Alignment: to line up with agents close by
	- Macroscopic Models
		- Simulate crowd motion from a macro perspective
			- Treat the crowd as a unified and continuous entity 
			- Control motions with potential field or fluid dynamics 
			- Does not consider interactions between individuals and the environment in individual level
		- Example：
			- Flow Field In UE5 MassAI
	- Mesoscopic Models
		- Simulate crowd motion taking care of both details and the whole
			- Divide the crowd into groups 
			- Deals with interactions between groups and individuals in each group 
			- combinations of microscopic models and formation rules or psychological models
- Collision Avoidance （可以让AI做，但是会很费）
	-  Force-based Models（基于力）
		- A mixture of socio-psychological and physical forces influencing the behavior in a crowd 
		- The actual movement of an individual depends on the desired velocity and its interaction with the environment 
		- Can simulate dynamical features of escape crowd panic
		- 每个小个体判断与障碍物的距离，越近产生越大的斥力，障碍物周围建立距离场
		- Pros: 
			- can be extended to simulate more emergent behaviors of human crowds 
		- Cons: 
			- Similar to physics simulation, simulation step should be small enough
	- Velocity-based models
		- Consider the neighbor information to make decisions in velocity space
			- able to simulate in local space 
			- applied to collision avoidance
		- Reciprocal Velocity obstacle methods – Current standard collision avoidance algorithms
			- Velocity Obstacle (VO) 
			- Reciprocal Velocity Obstacle (RVO) 
			- Optimal Reciprocal Collision Avoidance (ORCA)


### Sensing（Perception）
- 把sensing的频率开放出去，避免出现瓶颈
- 相近范围内的agent共享sensing
- Information
	- Interal Information
	- External Infomation
		- Static Spatial Information
		- Dynamic Spatial Information
		- Character Information
- Internal Information
	- Information of the agent itself 
		- Position 
		- HP 
		- Armor status 
		- Buff status 
		- … 
	- Can be accessed freely
- Static Spatial Information
	- Navigation Data
	- Tactical Map（战术地图，不同的地区有不同的价值）
	- Smart Object
	- Cover Point
- Dynamic Spatial Information
	- Influence Map（某个地区的威胁值动态变化，根据不同的威胁值作出反应）
	- Marks on navigation data（障碍物位置的变化）
	- Sight Area
	- Game Objects
		- 是不是同一个阵营，是不是可以看到，它能不能看到我
		- Information being sensed from a character
		- Multiple character information can exist for a single character as it can be sensed by multiple agents
		- Usually contains: 
			- Game Object ID 
			- Visibility 
			- Last Sensed Method 
			- Last Sensed Position
- Sensing Simulation
	- Light, sound, and odor travels in space 
	- Have max traveling range 
	- Attenuates in space and time with different patterns 
		- Sight is blocked by obstacles 
		- Smelling ranges shrinks over time 
	- Radiating field can simulate sensing signals 
		- Can be simplified as Influence Map 
		- Agents covered by the field can sense the information


### Classic Decision Making Algorithms
- Finite State Machine（FSM）
	- State
	- Conditions
	- Transition
	- Pros 
		- Easy to implement
		- Easy to understand 
		- Very fast to deal with simple case
	- Cons 
		- Maintainability is bad, especially add or remove state 
		- Reusability is bad, can’t used in other projects or characters 
		- Scalability is bad, hard to modify for complicated case
- Hierarchical Finite State Machine (HFSM)
	- Tradeoff between reactivity and modularity
		- Reactivity: the ability to quickly and efficiently react to changes 
		- Modularity:the degree to which a system’s components may be separated into building blocks, and recombined
		- 可以解决状态非常多导致混乱的问题，但是子状态机里面的状态不能直接切换到另一个子状态机里面，必须要通过固定的口子出去![[Pasted image 20230122181056.png]]
- Behavior Tree
	- Focus on state abstraction and transition conditions
	- Similar to human thinking
- Hierarchical Tasks Network 
- Goal Oriented Action Planning 
- Monte Carlo Tree Search 
- Deep Learning