- Basics 
	- Network Protocols 
		- TCP, UDP and Reliable UDP 
	- Clock Synchronization 
	- Remote Procedure Call (RPC) 
	- Network Topology 
	- Game Synchronization 
		- Snapshot Sync. 
		- Lockstep Sync. 
		- State Sync.
- Advanced 
	- Character Movement Replication 
	- Hit Registration 
	- Lag Compensation 
	- MMO Game Network Architecture 
	- AOI 
	- Anticheat 
	- The Future


### Network Protocols
- How to communication between two PCs
	- A and B must agree on the meaning of the bits being sent and received at many different levels, including 
		- How many volts represents a 0 bit, and for a 1 bit? 
		- How does receiver know which is the last bit? 
		- How many bits long is a number?
- Transmission Control Protocol (TCP)
	- Connection-Oriented 
	- Reliable and Ordered 
	- Flow Control 
	- Congestion Control
- UDP Features
	- Connectionless 
	- UnReliable and Unordered 
	- NO Flow Control 
	- NO Congerstion Control
- TCP VS UDP![[Pasted image 20230124104503.png]]
- Reliable UDP
	- TCP is Not Time Critical
		- TCP is the complex and heavyweight protocol. It provides reliable delivery and advanced features, but it has more overhead 
		- TCP is a fair, traffic oriented protocol designed to improve bandwidth utilization. But it's not designed for speed
	- UDP is Fast but Unreliable
		- UDP is lightweight and fast but unreliable, packet loss and disorder will occur 
	- Why We Need to Customize Protocol
		- Game Server（对于服务器来讲，需求如下） 
			- Keep-alived connection (TCP) 
			- Need keep logic consistency in “order” (TCP) 
			- High responsive & low latency (UDP) 
			- Broadcast commonly used (UDP) 
	- 实现方式
		- Acknowledgement & Sequence Number
			- Positive acknowledgment (ACK) is a signal that is passed between communicating processes, computers, or devices to signify acknowledgment, or receipt of message •
			- Negative ACK (NACK or NAK) is a signal that is sent to reject a previously received message or to indicate some kind of error 
			- Sequence number (SEQ) is a counter used to keep track of every byte sent outward by a host 
			- Timeouts specified periods of time allowed to elapse before an acknowledgment is to be received
		- Automatic Repeat Request (ARQ)
			- An error-control method for data transmission that uses ACK and timeouts to achieve reliable data transmission over an unreliable communication channel. 
			- If the sender does not receive an acknowledgment before the timeout, it re-transmits the packet until it receives an acknowledgment or exceeds a predefined number of retransmissions 
				- Sliding window protocol 
					- Stop-and-Wait ARQ 
					- Go-Back-N ARQ 
					- Selective Repeat ARQ
			- what is Sliding window protocol
				- Send mutilple frames at a time, number of frames to be sent is based on Window size 
				- Each frame is numbered by Sequence number 
				- When the frame at the front of the window is received, the window slides![[Pasted image 20230124105806.png]]
				- 窗口滑动策略
					- Stop-and-Wait ARQ
						- Windows size = 1 
						- After transmitting one frame, the sender waits for an ACK before transmitting the next frame 
						- If the ACK does not arrive after a certain time, the sender times out and retransmits the original frame 
						- Poor utilization of bandwidth, poor performance![[Pasted image 20230124105914.png]]
					- Go-Back-N ARQ
						- N is Sender's Windows Size 
						- The Receiver only sends cumulative ACK 
						- If an ACK is not received within an agreedupon time period, all frames in the current window are transmitted![[Pasted image 20230124110016.png]]
					- Selective Repeat ARQ
						- In Selective Repeat ARQ, only the damaged or lost frames are retransmitted 
						- The receiver sends the ack of each frame, and the sender maintains the timeout time of each frame 
						- When receiver receive damaged packet, it will send a NACK, The sender will send/retransmit frame for which NACK is received![[Pasted image 20230124110042.png]]
		- Make UDP Reliable in Packet Loss Scenario
			- With the increase of packet loss rate and delay, the reliable UDP can not meet the transmission requirements gradually.eg.If packet loss rate increase to 20%, use reliable UDP is still with high delay
			- Forward Error Correction (FEC)
				- The transmission of enough additional redundant information with the primary data stream to reconstruct lost IP packets up to a certain extent![[Pasted image 20230124111327.png]]
				- Reduce packet loss rate, but cost addtional bandwidth 
				- The packet loss rate is high, the effect of packet loss compensation is more obvious 
				- Two FEC algorithms 
					- XOR FEC 
					- Reed-Solomon Codes
				- XOR-FEC![[Pasted image 20230124111421.png]]
				- Reed-Solomon Codes
					- 1![[Pasted image 20230124111454.png]]
					- 2![[Pasted image 20230124111503.png]]
					- 3![[Pasted image 20230124111512.png]]
	- Customize Your UDP based on ARQ and FEC
		- Reliability 
			- Use Selective Repeat ARQ
		- Hybrid ARQ and FEC 
			- Before ARQ, FEC is used for error correction
		- Real-time 
			- Smaller RTO growth 
			- No congestion control 
			- Fast retransmission mechanism 
			- No delay ACK
		- Flexibility 
			- Design protocol for speed 
			- Support both reliable and unreliable transmission


### Clock Synchronization
- Round-Trip Time（RTT）
	- Send/Recv delay
	- Propagation delay
	- Response time of the origin server
- RTT vs. Ping
	- Ping tests are usually performed within a transport protocol that uses ICMP packets 
	- RTT is measured at the application layer
- RTT vs. Latency
	- Latency is the time required for a data packet to travel from the sending endpoint to the receiving endpoint (only one trip)
- Network Time Protocol (NTP)
	- Network Time Protocol is an internet protocol used to synchronize with computer clock time sources in a network
	- Reference clock 
		- GPS clock or radio ransmiiting station 
		- Amazinglly precise timekeeping devices such as atomic clocks 
		- Not connected to the internet 
		- Send their time through radio or optical fiber
	- NTP Algorithm
		- Client ask time server for time
		- Server receives the request and reply
		- Client receives the reply
		- 计算方式![[Pasted image 20230124133002.png]]
		- 举个例子![[Pasted image 20230124133043.png]]
	- NTP算法有个隐式的条件，上行带宽等于下行带宽，但是实际上很难相等。
	- Stream-Based Time Synchronization with Elimination of Higher Order Modes
		- 使用这个方式可以逼近服务器的时间，但是不可能完全相等
		- 建立链接的第一步就是要同步时间。
		1. Client stamps current local time on a "time request" packet and sends to server 
		2. Upon receipt by server, server stamps server-time and returns
		3. Upon receipt by client, a time delta is calculated by delta = (current Time-sent Time) / 2
		4. The first result should immediately be used to update the clock
		5. The client repeats Steps 1-3 (NTP-like process), five or more times 
		6. The results of the packet receipts are accumulated and sorted in ascending order by latency 
		7. All samples above that are approximately 1.5 times the median are discarded, and the remaining samples are averaged using an arithmetic mean


### Remote Procedure Call (RPC)
