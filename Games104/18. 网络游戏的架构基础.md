- Basics 
	- Network Protocols 
		- TCP, UDP and Reliable UDP 
	- Clock Synchronization 
	- Remote Procedure Call (RPC) 
	- Network Topology 
	- Game Synchronization 
		- Snapshot Sync. 
		- Lockstep Sync. 
		- State Sync.
- Advanced 
	- Character Movement Replication 
	- Hit Registration 
	- Lag Compensation 
	- MMO Game Network Architecture 
	- AOI 
	- Anticheat 
	- The Future


### Network Protocols
- How to communication between two PCs
	- A and B must agree on the meaning of the bits being sent and received at many different levels, including 
		- How many volts represents a 0 bit, and for a 1 bit? 
		- How does receiver know which is the last bit? 
		- How many bits long is a number?
- Transmission Control Protocol (TCP)
	- Connection-Oriented 
	- Reliable and Ordered 
	- Flow Control 
	- Congestion Control
- UDP Features
	- Connectionless 
	- UnReliable and Unordered 
	- NO Flow Control 
	- NO Congerstion Control
- TCP VS UDP
	- 对比图![[Pasted image 20230124104503.png]]
- Reliable UDP
	- TCP is Not Time Critical
		- TCP is the complex and heavyweight protocol. It provides reliable delivery and advanced features, but it has more overhead 
		- TCP is a fair, traffic oriented protocol designed to improve bandwidth utilization. But it's not designed for speed
	- UDP is Fast but Unreliable
		- UDP is lightweight and fast but unreliable, packet loss and disorder will occur 
	- Why We Need to Customize Protocol
		- Game Server（对于服务器来讲，需求如下） 
			- Keep-alived connection (TCP) 
			- Need keep logic consistency in “order” (TCP) 
			- High responsive & low latency (UDP) 
			- Broadcast commonly used (UDP) 
	- 实现方式
		- Acknowledgement & Sequence Number
			- Positive acknowledgment (ACK) is a signal that is passed between communicating processes, computers, or devices to signify acknowledgment, or receipt of message •
			- Negative ACK (NACK or NAK) is a signal that is sent to reject a previously received message or to indicate some kind of error 
			- Sequence number (SEQ) is a counter used to keep track of every byte sent outward by a host 
			- Timeouts specified periods of time allowed to elapse before an acknowledgment is to be received
		- Automatic Repeat Request (ARQ)
			- An error-control method for data transmission that uses ACK and timeouts to achieve reliable data transmission over an unreliable communication channel. 
			- If the sender does not receive an acknowledgment before the timeout, it re-transmits the packet until it receives an acknowledgment or exceeds a predefined number of retransmissions 
				- Sliding window protocol 
					- Stop-and-Wait ARQ 
					- Go-Back-N ARQ 
					- Selective Repeat ARQ
			- what is Sliding window protocol
				- Send mutilple frames at a time, number of frames to be sent is based on Window size 
				- Each frame is numbered by Sequence number 
				- When the frame at the front of the window is received, the window slides![[Pasted image 20230124105806.png]]
				- 窗口滑动策略
					- Stop-and-Wait ARQ
						- Windows size = 1 
						- After transmitting one frame, the sender waits for an ACK before transmitting the next frame 
						- If the ACK does not arrive after a certain time, the sender times out and retransmits the original frame 
						- Poor utilization of bandwidth, poor performance![[Pasted image 20230124105914.png]]
					- Go-Back-N ARQ
						- N is Sender's Windows Size 
						- The Receiver only sends cumulative ACK 
						- If an ACK is not received within an agreedupon time period, all frames in the current window are transmitted![[Pasted image 20230124110016.png]]
					- Selective Repeat ARQ
						- In Selective Repeat ARQ, only the damaged or lost frames are retransmitted 
						- The receiver sends the ack of each frame, and the sender maintains the timeout time of each frame 
						- When receiver receive damaged packet, it will send a NACK, The sender will send/retransmit frame for which NACK is received![[Pasted image 20230124110042.png]]
		- Make UDP Reliable in Packet Loss Scenario
			- With the increase of packet loss rate and delay, the reliable UDP can not meet the transmission requirements gradually.eg.If packet loss rate increase to 20%, use reliable UDP is still with high delay
			- Forward Error Correction (FEC)
				- The transmission of enough additional redundant information with the primary data stream to reconstruct lost IP packets up to a certain extent![[Pasted image 20230124111327.png]]
				- Reduce packet loss rate, but cost addtional bandwidth 
				- The packet loss rate is high, the effect of packet loss compensation is more obvious 
				- Two FEC algorithms 
					- XOR FEC 
					- Reed-Solomon Codes
				- XOR-FEC![[Pasted image 20230124111421.png]]
				- Reed-Solomon Codes
					- 1![[Pasted image 20230124111454.png]]
					- 2![[Pasted image 20230124111503.png]]
					- 3![[Pasted image 20230124111512.png]]
	- Customize Your UDP based on ARQ and FEC
		- Reliability 
			- Use Selective Repeat ARQ
		- Hybrid ARQ and FEC 
			- Before ARQ, FEC is used for error correction
		- Real-time 
			- Smaller RTO growth 
			- No congestion control 
			- Fast retransmission mechanism 
			- No delay ACK
		- Flexibility 
			- Design protocol for speed 
			- Support both reliable and unreliable transmission


### Clock Synchronization
- Round-Trip Time（RTT）
	- Send/Recv delay
	- Propagation delay
	- Response time of the origin server
- RTT vs. Ping
	- Ping tests are usually performed within a transport protocol that uses ICMP packets 
	- RTT is measured at the application layer
- RTT vs. Latency
	- Latency is the time required for a data packet to travel from the sending endpoint to the receiving endpoint (only one trip)
- Network Time Protocol (NTP)
	- Network Time Protocol is an internet protocol used to synchronize with computer clock time sources in a network
	- Reference clock 
		- GPS clock or radio ransmiiting station 
		- Amazinglly precise timekeeping devices such as atomic clocks 
		- Not connected to the internet 
		- Send their time through radio or optical fiber
	- NTP Algorithm
		- Client ask time server for time
		- Server receives the request and reply
		- Client receives the reply
		- 计算方式![[Pasted image 20230124133002.png]]
		- 举个例子![[Pasted image 20230124133043.png]]
	- NTP算法有个隐式的条件，上行带宽等于下行带宽，但是实际上很难相等。
	- Stream-Based Time Synchronization with Elimination of Higher Order Modes
		- 使用这个方式可以逼近服务器的时间，但是不可能完全相等
		- 建立链接的第一步就是要同步时间。
		1. Client stamps current local time on a "time request" packet and sends to server 
		2. Upon receipt by server, server stamps server-time and returns
		3. Upon receipt by client, a time delta is calculated by delta = (current Time-sent Time) / 2
		4. The first result should immediately be used to update the clock
		5. The client repeats Steps 1-3 (NTP-like process), five or more times 
		6. The results of the packet receipts are accumulated and sorted in ascending order by latency 
		7. All samples above that are approximately 1.5 times the median are discarded, and the remaining samples are averaged using an arithmetic mean


### Remote Procedure Call (RPC)
- Socket Programming, Lots for the programmer to deal with every time 
	- How to separate different requests on the same connection? 
	- How to write bytes to the network/read bytes from the network? 
	- What if Host A's process is written in Go and Host B’s process is in C++? 
	- What to do with those bytes?
- Communication with Messages
	- Initially, people "hand-coded" messages to send requests and responses 
		- Message is a stream of bytes – "op codes" and operands
	- Lots of drawbacks 
		- Need to worry about message format 
		- Have to pack and unpack data from messages 
		- Servers have to decode messages and dispatch them to handlers 
		- Messages are often asynchronous 
		- After sending one, what do you do until the response comes back? 
		- Messages aren’t a natural programming model
- More Challenges on Logic Communication
		- For a remote procedure call, a remote machine may: 
			- Run process written in a different language 
			- Represent data types using different sizes 
			- Use a different byte ordering (endianness) 
			- Represent floating point numbers differently 
			- Have different data alignment requirements e.g., 4-byte type begins only on 4-byte memory boundary
- Remote Procedure Call (RPC)
	- RPC is a request–response protocol. An RPC is initiated by the client, which sends a request message to a known remote server to execute a specified procedure with supplied parameters![[Pasted image 20230124135017.png]]
	- Goals 
		- Ease of programming 
		- Hide complexity 
		- Familiar model for programmers (just make a function call)
- Why RPC?
	- Goal: Easy-to-program network communication that makes client-server communication transparent
		- Retains the "feel" of writing centralized code 
			- Programmers needn't think about the network 
			- Make communication appear like a local procedure call 
		- Don't need to worry about serialization/deserialization for network 
		- Don't need to worry about complexities of network
- Interface Definition Language
	- A server defines the service interface using an interface definition language (IDL)
	- The IDL specifies the names, parameters, and types for all client-callable server procedures
		- example: Protobuf (Google's data interchange format)
- RPC Stubs
	- A client-side stub is a procedure that looks to the client as if it were a callable server procedure 
		- The client program thinks it's invoking the server but it's calling into the client-side stub
	- A server-side stub looks like a caller to the server 
		- The server program thinks it's called by the client but it's really called by the server-side stub
	- The stubs send messages to each other to make the RPC happen transparently
	- ![[Pasted image 20230124135403.png]]
- Stub Compiler
	- A "stub compiler" reads the IDL declarations and produces two stub procedures for each server procedure 
		- The server programmer implements the service's procedures and links them with the server-side stubs 
		- The client programmer implements the client program and links it with the client-side stubs 
		- The stubs manage all of the details of remote communication between client and server
- Real RPC Package Journey
	- 流程图![[Pasted image 20230124135534.png]]



### Network Topology
- Original Peer-to-Peer (P2P)
	- Each client broadcasts game event to the all others 
	- Robustness 
	- Cheating is much easier 
	- Synchronization is required among all nodes to maintain the consistency of the distributed game state
- P2P with Host Server
	- A player can act as "server", known as host 
	- If host disconnected, the game may end 
	- The host need to handle game actor that can not be controled by players, such as bot
- P2P Games（可以用P2P方式的游戏）
	- No rely on server 
	- Used in Lan commonly 
	- The “Host” is basically in control of the sessions 
	- A limited number of players at once
- Dedicated Server
	- Authority 
	- Simulate game world 
	- Dispatch data to players 
	- High performance requirements
- P2P VS Dedicated Server
	- 对比![[Pasted image 20230124152046.png]]
- When RTT is too high
	- When players are in different countries, far away, or when the network environment is complex 
	- Use dedicated line and edge gateway to reduce latency（在城市里面设立专门的网关，网关直连服务器，不通过公网路由，来保证低延迟）



### Game Synchronization
- Synchronization Methods
	- Snapshot（quake）
	- Lockstep（Honor of Kings， doom）
	- State Synchornization（Counter Strike）
- Snapshot Synchronization
	- 流程
		- Client sends inputs to server
		- Server simulates the game world 
		- Generates whole game state snapshots 
		- Sends them down to clients 
		- Client updates the display according to the snapshot
	- Jitter and Hitches（抖动和障碍）
		- Server tick rate is limited
			- Performance 
			- Bandwidth
	- 改进
		- Snapshot Interpolation
			- Not rendering immediately after snapshot recevied 
			- Keep an interpolation buffer 
			- Interpolation between the two delayed snapshots
		- Delta Compression
			- Only sync snapshot delta to client 
			- Example Quake3
	- 总结
		- Client performance is wasted 
		- High server pressure 
		- High data volume and high bandwidth requirements 
		- As games get more complex, snapshots get bigger
- Lockstep Synchronization
	- Lockstep synchronization, used in military simulation, is by far the simplest techique to ensure consistency
		- Same Result 
			- Same time 
			- Same action
	- Lockstep Principle
		- 概念![[Pasted image 20230124154336.png]]
	- First Game Used Lockstep
		- The network synchronization method of DOOM (1994) was pointed out in a 2006 paper 
		- Lockstep is not mentioned in the paper, but it is now generally accepted that Doom (1994) was the first multiplayer FPS online game to use this type of synchronization 
		- It uses P2P architecture
	- Lockstep Initialization
		- Ensure that the initial data of each client is deterministic 
			- Game model 
			- Static data 
			- ... 
		- Synchronize clock
	- Deterministic Lockstep（偏向准确性，对网络差者有利）
		- 流程
			- 流程图![[Pasted image 20230124154746.png]]
			- Client sends inputs to Server 
			- Server receives and sorts 
			- Wait for input from all clients before forwarding 
			- After receiving data from the server, the client executes the game logic
		- 缺点
			- Game progress depends on slowest player 
			- The delay of the game is not fixed, the experience is not good 
			- All the players will wait if a player offline
	- Bucket Synchronization（更偏向实时性，对网络好者有利）
		- 流程图![[Pasted image 20230124154909.png]]
		- Bucket: a fixed time period 
		- Each bucket 
			- Collect all instructions 
			- Broadcast to all players 
		- There is no need to wait for all players' commands to be received before forwarding
	- Deterministic Difficulties
		- Deterministic 
			- The same input sequence need to produce the same game state on all machines
		- Deterministic is Hard 
			- Floating point 
			- Random number 
			- Containers and algorithms (sort, add, remove, etc.) 
			- Math tools (vectors, quaternions, etc) 
			- Physics simulation (very difficult) 
			- Code logic execution order